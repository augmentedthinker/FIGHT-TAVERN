<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dungeon Master's Chronicle</title>
    
    <!-- --- LIBRARIES --- -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for Battle UI -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- Three.js Import Map -->
    <script type="importmap">
        { "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
            "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
        }}
    </script>

    <!-- --- FONTS --- -->
    <link href="https://fonts.googleapis.com/css2?family=Alegreya:wght@400;700&family=Pirata+One&family=MedievalSharp&display=swap" rel="stylesheet">
    
    <!-- --- CSS --- -->
    <link rel="stylesheet" href="styles.css">

    <!-- Tailwind Config for Battle Animations -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { medieval: ['MedievalSharp', 'cursive'] },
                    animation: {
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'pop': 'pop 0.3s ease-out forwards',
                        'pulse-glow': 'pulseGlow 2s infinite',
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        pop: {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        pulseGlow: {
                            '0%, 100%': { opacity: '1', filter: 'brightness(1)' },
                            '50%': { opacity: '0.8', filter: 'brightness(1.2)' }
                        }
                    }
                }
            }
        }
    </script>
</head>
<body>
    
    <!-- === PART 0: Title Screen === -->
    <div id="title-screen">
        <h1 class="main-title">Dungeon Master's<br>Chronicle</h1>
        <div class="title-menu">
            <button class="title-btn" onclick="startGame()">Start Game</button>
            <button class="title-btn" onclick="loadGame()">Load Game</button>
            <button class="title-btn" onclick="alert('Options Menu coming soon!')">Options</button>
        </div>
    </div>

    <!-- === PART 1: Intro (React) === -->
    <div id="root" class="scene-container"></div>

    <!-- === PART 2: The Gates (React + Three) === -->
    <div id="gate-root" class="scene-container"></div>

    <!-- === PART 3: Tavern (Vanilla JS) === -->
    <div id="sanctuary-wrapper">
        <div id="game-container">
            <img id="scene-image" src="" alt="Scene Background">
            <div id="top-title-container"><h1 id="scene-title"></h1></div>
            <div id="character-hud">
                <div class="stat-line">STR: <span id="str-val" class="stat-val">0</span></div>
                <div class="stat-line">DEX: <span id="dex-val" class="stat-val">0</span></div>
                <div class="stat-line">INT: <span id="int-val" class="stat-val">0</span></div>
                <div class="stat-line">CHA: <span id="cha-val" class="stat-val">0</span></div>
                <div class="stat-line" style="border-top: 1px solid #333; margin-top:5px; padding-top:5px; color:#ffd700;">GOLD: <span id="gold-val" class="stat-val" style="color:#ffd700;">5</span></div>
            </div>
            <div id="dialogue-area"><p id="dialogue-text">...</p></div>
            <div id="choice-grid"></div>
            <div id="controls-left" onclick="loadScene('hub')" title="Return to Tavern">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="32" height="32" stroke="#f59e0b">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
            </div>
            <div id="save-btn" onclick="saveGame()" title="Save Game">
                <i data-lucide="save" style="color:#f59e0b; width:24px; height:24px;"></i>
            </div>
            <div id="dice-toggle-btn" onclick="toggleDiceModal()" title="Open Dice Roller">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12.8 3.6a2 2 0 0 0-1.6 0l-7 4A2 2 0 0 0 3 9.4v5.2a2 2 0 0 0 1.2 1.8l7 4a2 2 0 0 0 1.6 0l7-4a2 2 0 0 0 1.2-1.8V9.4a2 2 0 0 0-1.2-1.8z"></path>
                    <path d="m12 11.3 7.8-4.5"></path>
                    <path d="m3 7.9 7.8 4.5v9"></path>
                    <path d="m13.2 21.4-.4-9 7.8-4.5"></path>
                </svg>
            </div>
            <div id="journal-btn" onclick="toggleJournal()" title="Open Story Journal">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
            </div>
        </div>
        
        <!-- Modals -->
        <div id="journal-modal" onclick="toggleJournal()">
            <div id="journal-content" onclick="event.stopPropagation()">
                <h2>Your Tale</h2>
                <div id="story-log"></div>
                <button class="btn-choice" style="width:100%; margin-top:20px;" onclick="toggleJournal()">Close</button>
            </div>
        </div>
        <div id="memory-modal">
            <div id="memory-header">
                <button id="memory-back-btn" onclick="closeMemory()">Back</button>
                <h2 id="memory-title">A Fading Memory</h2>
                <div style="width: 80px;"></div>
            </div>
            <div id="memory-img-container"><img id="memory-img" src="" alt="Loading memory..."></div>
        </div>
        <div id="dice-modal-overlay">
            <button id="close-dice-btn" onclick="toggleDiceModal()">&times;</button>
            <div id="dice-widget" onclick="event.stopPropagation()">
                <div id="widget-ui">
                    <div class="dice-header">
                        <div class="dice-title">Polyhedral Engine</div>
                        <div id="color-picker-wrapper">
                            <button id="current-color-btn" title="Change Dice Color"></button>
                            <div id="color-dropdown">
                                <button class="color-option" data-color="0x3b82f6" style="background: #3b82f6;"></button>
                                <button class="color-option" data-color="0xef4444" style="background: #ef4444;"></button>
                                <button class="color-option" data-color="0x22c55e" style="background: #22c55e;"></button>
                                <button class="color-option" data-color="0xa855f7" style="background: #a855f7;"></button>
                                <button class="color-option" data-color="0xeab308" style="background: #eab308;"></button>
                                <button class="color-option" data-color="0x334155" style="background: #334155;"></button>
                            </div>
                        </div>
                    </div>
                    <div id="result-display">20</div>
                    <div class="controls-area">
                        <div class="dice-selector">
                            <button class="die-btn" id="btn-d4" data-sides="4">D4</button>
                            <button class="die-btn" id="btn-d6" data-sides="6">D6</button>
                            <button class="die-btn" id="btn-d8" data-sides="8">D8</button>
                            <button class="die-btn" id="btn-d10" data-sides="10">D10</button>
                            <button class="die-btn" id="btn-d12" data-sides="12">D12</button>
                            <button class="die-btn active" id="btn-d20" data-sides="20">D20</button>
                        </div>
                        <button id="roll-btn">Roll Dice</button>
                    </div>
                </div>
                <div id="canvas-container"></div>
            </div>
        </div>
    </div>

    <!-- FIGHT WIDGET MODAL -->
    <div id="fight-modal">
        <!-- === LOBBY VIEW === -->
        <div id="lobby-panel" class="z-10 widget-container items-center justify-center p-8 text-center animate-pop h-auto min-h-[500px]">
            <button onclick="toggleFightModal()" class="absolute top-2 right-2 text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <i data-lucide="beer" class="w-16 h-16 text-yellow-600 mb-4 mx-auto"></i>
            <h1 class="text-3xl font-bold text-yellow-500 mb-2">THE FIGHTING TAVERN</h1>
            
            <div class="bg-slate-800/80 rounded-lg p-4 w-full mb-6 border border-slate-600">
                <div class="text-xs uppercase text-slate-400 font-bold mb-1 tracking-widest">Tavern Status</div>
                <div id="lobby-status-text" class="text-lg text-white font-bold animate-pulse-glow">Connecting...</div>
                <div id="lobby-count" class="text-xs text-slate-500 mt-1"></div>
            </div>

            <!-- Dynamic Lobby Actions -->
            <div id="lobby-actions" class="w-full space-y-3"></div>
            
            <!-- Challenge Notification -->
            <div id="challenge-modal" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center p-6 z-50 animate-pop">
                <h2 class="text-2xl text-yellow-500 font-bold mb-2">CHALLENGE!</h2>
                <p class="text-slate-300 text-sm mb-6">A rival warrior wants to fight.</p>
                <button onclick="app.acceptChallenge()" class="w-full bg-red-600 hover:bg-red-500 text-white py-4 rounded-lg font-bold mb-3 animate-pulse">
                    ACCEPT BATTLE
                </button>
                <div class="text-xs text-slate-500">Wait to decline...</div>
            </div>
        </div>

        <!-- === GAME WIDGET === -->
        <div id="game-widget" class="widget-container hidden animate-pop">
            <!-- Header -->
            <div class="flex justify-between items-center px-3 py-2 bg-slate-900/90 border-b border-slate-700 z-30">
                <div class="flex items-center gap-2">
                    <i data-lucide="swords" class="w-4 h-4 text-yellow-500"></i>
                    <div id="role-alert" class="text-xs font-bold text-slate-300 uppercase tracking-wider">Loading...</div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="battle.resetGame()" class="text-slate-500 hover:text-yellow-400"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                    <button onclick="toggleFightModal()" class="text-slate-500 hover:text-white"><i data-lucide="log-out" class="w-4 h-4"></i></button>
                </div>
            </div>

            <!-- BATTLE STAGE -->
            <div class="battle-stage">
                <!-- Hero Panel -->
                <div id="hero-card" class="char-panel group">
                    <img id="hero-img" src="" class="char-img" alt="Warrior">
                    <div class="char-hud">
                        <div class="flex justify-between text-xs font-bold text-blue-300 mb-1">
                            <span class="drop-shadow-md">WARRIOR</span> <span id="hero-hp-text">50/50</span>
                        </div>
                        <div class="hp-track">
                            <div id="hero-bar" class="hp-fill bg-blue-500" style="width: 100%"></div>
                            <div id="hero-chip" class="hp-chip" style="width: 100%"></div>
                        </div>
                    </div>
                </div>

                <!-- Enemy Panel -->
                <div id="enemy-card" class="char-panel group">
                    <img id="enemy-img" src="" class="char-img" alt="Ogre">
                    <div class="char-hud">
                        <div class="flex justify-between text-xs font-bold text-red-300 mb-1">
                            <span class="drop-shadow-md">OGRE</span> <span id="enemy-hp-text">45/45</span>
                        </div>
                        <div class="hp-track">
                            <div id="enemy-bar" class="hp-fill bg-red-500" style="width: 100%"></div>
                            <div id="enemy-chip" class="hp-chip" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTROL DECK -->
            <div class="control-deck">
                <div class="flex-1 text-left pr-4">
                    <div class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Battle Log</div>
                    <div id="action-log" class="text-sm font-bold text-slate-200 truncate leading-tight">Roll for initiative...</div>
                    <div id="math-log" class="text-[10px] font-mono text-yellow-600/80 h-3 leading-none mt-1"></div>
                </div>

                <div id="d20-btn" class="die-btn-widget die-disabled" onclick="battle.sendAttack()">
                    <svg viewBox="0 0 100 100" class="w-full h-full overflow-visible">
                        <path d="M50 5 L92 28 L92 72 L50 95 L8 72 L8 28 Z" class="fill-slate-800 stroke-slate-600 stroke-2 transition-colors" id="die-bg"/>
                        <text x="50" y="62" text-anchor="middle" class="fill-slate-500 font-sans font-black text-2xl select-none" id="die-text">20</text>
                    </svg>
                </div>
            </div>

            <!-- CHAT -->
            <div class="chat-section">
                <div id="chat-messages" class="chat-scroll space-y-1.5">
                    <div class="text-slate-600 text-center italic text-xs mt-1 opacity-50">-- Tavern Chat --</div>
                </div>
                <form onsubmit="battle.sendChat(event)" class="p-2 bg-slate-950 flex gap-2 border-t border-slate-800">
                    <input id="chat-input" class="flex-1 bg-slate-900 border border-slate-700 rounded px-3 py-2 text-xs text-white focus:outline-none focus:border-yellow-600 placeholder-slate-600" placeholder="Type your message..." autocomplete="off">
                    <button type="submit" class="bg-slate-800 hover:bg-slate-700 text-white rounded px-3 transition-colors"><i data-lucide="send" class="w-4 h-4"></i></button>
                </form>
            </div>

            <!-- OVERLAY -->
            <div id="overlay" class="absolute inset-0 z-50 bg-black/95 flex flex-col items-center justify-center hidden p-6 text-center animate-pop">
                <i id="overlay-icon" data-lucide="skull" class="w-16 h-16 text-slate-700 mb-4"></i>
                <h1 class="text-4xl text-yellow-500 font-bold mb-2 tracking-tight" id="overlay-title">GAME OVER</h1>
                <p class="text-slate-400 mb-8 text-sm max-w-[200px]" id="overlay-sub">The battle has ended.</p>
                
                <button id="overlay-btn" onclick="battle.resetGame()" class="px-8 py-3 bg-red-900 border border-red-600 rounded-lg text-white font-bold hover:bg-red-800 transition-transform active:scale-95 shadow-lg shadow-red-900/20">
                    RETURN TO TAVERN
                </button>
            </div>
        </div>
    </div>

    <!-- === JAVASCRIPT MODULES === -->
    <script src="game-main.js"></script>
    <script src="battle-system.js"></script>
    <script type="module" src="dice-engine.js"></script>
    <script type="text/babel" src="react-scenes.js"></script>

</body>
</html>
