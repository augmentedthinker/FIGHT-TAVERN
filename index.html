<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Multiplayer Battle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        /* --- GLOBAL & UTILS --- */
        body { background-color: #000; color: #e2e8f0; font-family: 'MedievalSharp', cursive; overflow: hidden; touch-action: none; }
        .text-glow { text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000; }
        
        /* Glass Panel */
        .hud-panel { 
            background: rgba(15, 23, 42, 0.9); 
            backdrop-filter: blur(8px); 
            border-top: 1px solid rgba(255, 255, 255, 0.2); 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
        }

        /* --- SPLIT SCREEN LOGIC --- */
        /* Default (Mobile): Stack Vertical. MD (Desktop): Side by Side */
        .game-container { display: flex; flex-direction: column; width: 100%; height: 100%; }
        @media (min-width: 768px) { .game-container { flex-direction: row; } }

        .split-panel {
            position: relative; flex: 1; overflow: hidden;
            transition: all 0.5s ease;
            border: 4px solid #1e293b; /* Basic border */
        }
        
        /* Active Turn Highlighting */
        .active-turn { flex: 1.2; filter: brightness(1.1); z-index: 10; border-color: #facc15; box-shadow: inset 0 0 20px rgba(250, 204, 21, 0.2); }
        .inactive-turn { flex: 0.8; filter: grayscale(0.8) brightness(0.6); z-index: 0; border-color: #0f172a; }

        .split-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .active-turn .split-image { transform: scale(1.05); }

        /* Fancy Frame for Panels */
        .panel-frame {
            position: absolute; inset: 0; pointer-events: none; z-index: 20;
            border: 8px double rgba(255,255,255,0.1);
        }
        .active-turn .panel-frame { border-color: rgba(250, 204, 21, 0.4); }

        /* HP Bars */
        .hp-container {
            position: absolute; top: 1rem; width: 80%; z-index: 30;
            background: rgba(0,0,0,0.8); padding: 0.5rem; border-radius: 0.5rem;
            border: 1px solid rgba(255,255,255,0.2);
            left: 50%; transform: translateX(-50%);
        }
        .hp-track { width: 100%; height: 12px; background: #334155; border-radius: 2px; overflow: hidden; }
        .hp-fill { height: 100%; transition: width 0.3s ease; }

        /* Floating Text */
        @keyframes floatUp {
            0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
            10% { transform: translate(-50%, -20px) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -100px) scale(0.8); opacity: 0; }
        }
        .damage-text {
            position: absolute; left: 50%; top: 50%;
            font-size: 5rem; font-weight: 900;
            text-shadow: 4px 4px 0 #000; pointer-events: none; 
            animation: floatUp 2s ease-out forwards; z-index: 50;
        }

        /* Dice */
        .die-btn {
            width: 72px; height: 72px; transition: all 0.3s ease;
            filter: grayscale(1) opacity(0.5); cursor: not-allowed;
        }
        .die-active {
            filter: grayscale(0) opacity(1) drop-shadow(0 0 10px rgba(220, 38, 38, 0.5));
            cursor: pointer; animation: pulse 2s infinite;
        }
        .die-active:active { transform: scale(0.9); }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes roll { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .rolling svg { animation: roll 0.5s linear infinite; }

        /* Chat Toggle (Mobile) */
        #chat-panel { transition: transform 0.3s ease; }
        .chat-hidden { transform: translateY(110%); }
        .chat-visible { transform: translateY(0); }
    </style>
</head>
<body>

    <!-- === MAIN GAME CONTAINER === -->
    <div class="game-container">
        
        <!-- PLAYER 1 (Warrior) -->
        <div id="hero-panel" class="split-panel">
            <img id="hero-img" src="" class="split-image" alt="Warrior">
            <div class="panel-frame"></div>
            
            <!-- P1 HUD -->
            <div class="hp-container">
                <div class="flex justify-between text-xs font-bold mb-1 text-blue-300">
                    <span>WARRIOR (You)</span> <span id="hero-hp-text">50/50</span>
                </div>
                <div class="hp-track"><div id="hero-bar" class="hp-fill bg-blue-600" style="width: 100%"></div></div>
            </div>
        </div>

        <!-- PLAYER 2 (Ogre) -->
        <div id="enemy-panel" class="split-panel">
            <img id="enemy-img" src="" class="split-image" alt="Ogre">
            <div class="panel-frame"></div>

            <!-- P2 HUD -->
            <div class="hp-container">
                <div class="flex justify-between text-xs font-bold mb-1 text-red-300">
                    <span>OGRE</span> <span id="enemy-hp-text">45/45</span>
                </div>
                <div class="hp-track"><div id="enemy-bar" class="hp-fill bg-red-600" style="width: 100%"></div></div>
            </div>
        </div>

    </div>

    <!-- === BOTTOM CONTROLS (Fixed) === -->
    <div class="fixed bottom-0 left-0 w-full hud-panel pb-safe z-40 flex flex-col items-center justify-between px-4 py-2">
        
        <!-- Role Indicator -->
        <div id="role-badge" class="absolute top-[-12px] bg-black border border-white/20 text-[10px] uppercase font-bold px-3 py-1 rounded-full text-slate-400">
            Connecting...
        </div>

        <!-- Main Action Row -->
        <div class="flex w-full items-center justify-between max-w-2xl">
            
            <!-- Chat Toggle (Mobile) / Chat Box (Desktop) -->
            <div class="flex-1">
                <button onclick="battle.toggleChat()" class="md:hidden p-2 text-slate-400 hover:text-white">
                    <i data-lucide="message-square" class="w-6 h-6"></i>
                </button>
                <!-- Desktop Chat Placeholder -->
                <div class="hidden md:block text-xs text-slate-500 italic" id="desktop-chat-preview">Chat available</div>
            </div>

            <!-- Dice Center -->
            <div class="flex flex-col items-center mx-4">
                <div id="d20-btn" class="die-btn" onclick="battle.sendAttack()">
                    <svg viewBox="0 0 100 100" class="w-full h-full overflow-visible">
                        <path d="M50 5 L92 28 L92 72 L50 95 L8 72 L8 28 Z" class="fill-red-900 stroke-red-500 stroke-2" />
                        <text x="50" y="62" text-anchor="middle" class="fill-white font-sans font-black text-2xl">20</text>
                    </svg>
                </div>
            </div>

            <!-- Log / Info -->
            <div class="flex-1 text-right">
                <div class="text-[10px] text-slate-500 uppercase tracking-widest">Action Log</div>
                <div id="last-roll" class="text-sm font-bold text-white">-</div>
            </div>
        </div>

        <!-- Detailed Combat Text (The "Math") -->
        <div id="combat-details" class="text-xs text-yellow-500 font-mono mt-1 h-4"></div>

    </div>

    <!-- === CHAT OVERLAY (Mobile/Desktop Unified) === -->
    <div id="chat-panel" class="fixed bottom-24 left-4 w-64 bg-slate-900/95 border border-slate-700 rounded-lg p-3 z-50 shadow-2xl chat-hidden md:chat-visible md:bottom-28">
        <div class="flex justify-between items-center mb-2">
            <span class="text-xs font-bold text-slate-400 uppercase">Tavern Chat</span>
            <button onclick="battle.toggleChat()" class="md:hidden text-slate-500"><i data-lucide="x" class="w-3 h-3"></i></button>
        </div>
        <div id="chat-messages" class="h-32 overflow-y-auto text-xs space-y-1 mb-2"></div>
        <form onsubmit="battle.sendChat(event)" class="flex gap-1">
            <input id="chat-input" class="w-full bg-black/50 border border-slate-700 rounded px-2 py-1 text-xs text-white" placeholder="Type..." autocomplete="off">
        </form>
    </div>

    <!-- === GAME OVER OVERLAY === -->
    <div id="overlay" class="fixed inset-0 z-50 bg-black/90 flex flex-col items-center justify-center hidden">
        <h1 class="text-6xl text-white font-black mb-2" id="overlay-title">GAME OVER</h1>
        <button onclick="battle.resetGame()" class="px-6 py-2 bg-red-800 text-white rounded font-bold border border-red-500">PLAY AGAIN</button>
    </div>

    <script>
        const RAILWAY_URL = "https://fight-tavern-production.up.railway.app";
        const IMAGES = {
            warrior: "https://image.pollinations.ai/prompt/fantasy%20warrior%20portrait%20rugged%20face%20scarred%20armor%20heroic%20lighting%201970s%20dnd%20art%20style%20oil%20painting?width=600&height=1024&nologin=true&seed=99",
            ogre: "https://image.pollinations.ai/prompt/fearsome%20ogre%20portrait%20fantasy%20art%201970s%20style?width=600&height=1024&nologin=true&seed=505",
        };

        const socket = io(RAILWAY_URL);

        const battle = {
            myRole: null, isMyTurn: false, chatOpen: false,

            init() {
                document.getElementById('hero-img').src = IMAGES.warrior;
                document.getElementById('enemy-img').src = IMAGES.ogre;
                lucide.createIcons();
                this.setupSocket();
            },

            setupSocket() {
                socket.on('welcome', (data) => {
                    this.myRole = data.role;
                    const badge = document.getElementById('role-badge');
                    if(this.myRole === 'hero') { badge.innerText = "You are the Warrior"; badge.className += " text-blue-400 border-blue-900"; }
                    else if(this.myRole === 'enemy') { badge.innerText = "You are the Ogre"; badge.className += " text-red-400 border-red-900"; }
                    else { badge.innerText = "Spectator Mode"; }
                    this.updateUI(data.state);
                });

                socket.on('game_update', (data) => {
                    this.updateUI(data.state);
                    if(data.action) this.handleAction(data.action);
                    if(data.reset) document.getElementById('overlay').classList.add('hidden');
                });

                socket.on('chat_message', (data) => {
                    const box = document.getElementById('chat-messages');
                    const color = data.role === 'hero' ? 'text-blue-400' : (data.role === 'enemy' ? 'text-red-400' : 'text-slate-500');
                    const name = data.role === 'hero' ? 'WARRIOR' : (data.role === 'enemy' ? 'OGRE' : 'Spec');
                    box.innerHTML += `<div class="break-words"><span class="font-bold ${color}">${name}:</span> <span class="text-slate-300">${data.text}</span></div>`;
                    box.scrollTop = box.scrollHeight;
                    // Show a notification dot? (Optional improvement)
                });
            },

            sendAttack() {
                if(!this.isMyTurn) return;
                document.getElementById('d20-btn').classList.add('rolling');
                socket.emit('attack');
            },

            toggleChat() {
                this.chatOpen = !this.chatOpen;
                const panel = document.getElementById('chat-panel');
                if(this.chatOpen) {
                    panel.classList.remove('chat-hidden');
                    panel.classList.add('chat-visible');
                } else {
                    panel.classList.add('chat-hidden');
                    panel.classList.remove('chat-visible');
                }
            },

            sendChat(e) {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                if(input.value.trim()) {
                    socket.emit('send_chat', input.value.trim());
                    input.value = '';
                }
            },

            resetGame() { socket.emit('reset_game'); },

            updateUI(state) {
                // HP
                const setBar = (id, cur, max) => {
                    document.getElementById(id + '-hp-text').innerText = `${cur}/${max}`;
                    document.getElementById(id + '-bar').style.width = `${(cur/max)*100}%`;
                };
                setBar('hero', state.hero.hp, state.hero.max);
                setBar('enemy', state.enemy.hp, state.enemy.max);

                // Game Over
                if(state.gameOver) {
                    document.getElementById('overlay').classList.remove('hidden');
                    document.getElementById('overlay-title').innerText = state.hero.hp > 0 ? "WARRIOR WINS" : "OGRE WINS";
                    return;
                }

                // Turn Logic
                this.isMyTurn = (this.myRole === state.turn);
                const btn = document.getElementById('d20-btn');
                btn.classList.remove('rolling');

                if(this.isMyTurn) {
                    btn.classList.add('die-active');
                    document.getElementById('last-roll').innerText = "YOUR TURN";
                    document.getElementById('last-roll').className = "text-sm font-bold text-yellow-400 animate-pulse";
                } else {
                    btn.classList.remove('die-active');
                    const who = state.turn === 'hero' ? "WARRIOR" : "OGRE";
                    document.getElementById('last-roll').innerText = `${who}'S TURN`;
                    document.getElementById('last-roll').className = "text-sm font-bold text-slate-500";
                }

                // Active Panel
                const p1 = document.getElementById('hero-panel');
                const p2 = document.getElementById('enemy-panel');
                if(state.turn === 'hero') { p1.classList.add('active-turn'); p1.classList.remove('inactive-turn'); p2.classList.remove('active-turn'); p2.classList.add('inactive-turn'); }
                else { p2.classList.add('active-turn'); p2.classList.remove('inactive-turn'); p1.classList.remove('active-turn'); p1.classList.add('inactive-turn'); }
            },

            handleAction(action) {
                // Combat Text
                document.getElementById('last-roll').innerText = action.log.msg;
                document.getElementById('last-roll').className = `text-sm font-bold ${action.log.color}`;
                document.getElementById('combat-details').innerText = action.log.sub; // The Math

                // Visuals
                const targetId = action.attacker === 'hero' ? 'enemy-panel' : 'hero-panel';
                const panel = document.getElementById(targetId);
                
                if(action.isHit) {
                    // Flash Red
                    panel.style.backgroundColor = 'red';
                    setTimeout(() => panel.style.backgroundColor = '', 100);
                    
                    // Floating Text
                    const el = document.createElement('div');
                    el.className = 'damage-text text-red-500';
                    el.innerText = `-${action.damage}`;
                    panel.appendChild(el);
                    setTimeout(() => el.remove(), 2000);
                } else {
                    const el = document.createElement('div');
                    el.className = 'damage-text text-slate-400 text-6xl opacity-50';
                    el.innerText = "MISS";
                    panel.appendChild(el);
                    setTimeout(() => el.remove(), 2000);
                }
            }
        };

        window.onload = () => battle.init();
    </script>
</body>
</html>
