<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tavern Battle Widget</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { medieval: ['MedievalSharp', 'cursive'] },
                    animation: {
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'pop': 'pop 0.3s ease-out forwards',
                        'pulse-glow': 'pulseGlow 2s infinite',
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        pop: {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        pulseGlow: {
                            '0%, 100%': { opacity: '1', filter: 'brightness(1)' },
                            '50%': { opacity: '0.8', filter: 'brightness(1.2)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: #e2e8f0; font-family: 'MedievalSharp', cursive; overflow: hidden; }
        
        /* Widget Window */
        .widget-container {
            width: 100%; max-width: 420px; height: 100%; max-height: 750px;
            background: #0f172a;
            border: 1px solid #334155;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            border-radius: 12px;
            display: flex; flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- BATTLE AREA --- */
        .battle-stage {
            flex: 1; display: flex; position: relative; background: #000;
        }

        .char-panel {
            flex: 1; position: relative; overflow: hidden;
            border-right: 1px solid rgba(0,0,0,0.5);
            transition: filter 0.3s ease;
        }
        .char-panel:last-child { border-right: none; }

        .char-img {
            width: 100%; height: 100%; object-fit: cover; 
            transition: transform 0.5s ease;
        }

        .active-turn .char-img { transform: scale(1.1); filter: brightness(1.1); }
        .inactive-turn .char-img { filter: grayscale(0.8) brightness(0.6); }

        /* HUD Overlay */
        .char-hud {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
            padding: 20px 10px 10px 10px; z-index: 10;
        }

        /* HP Bars */
        .hp-track { width: 100%; height: 6px; background: #334155; border-radius: 3px; overflow: hidden; position: relative; margin-top: 4px; }
        .hp-fill { height: 100%; position: absolute; top: 0; left: 0; transition: width 0.3s; z-index: 2; }
        .hp-chip { height: 100%; position: absolute; top: 0; left: 0; background: white; transition: width 0.6s 0.3s; z-index: 1; }

        /* --- CONTROL DECK --- */
        .control-deck {
            height: 110px; background: #1e293b;
            border-top: 1px solid #334155; border-bottom: 1px solid #334155;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 1rem; position: relative; z-index: 20;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .die-btn { 
            width: 80px; height: 80px; 
            cursor: pointer; transition: transform 0.2s; 
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
        }
        .die-btn:active { transform: scale(0.95); }
        .die-disabled { filter: grayscale(1) opacity(0.5); cursor: not-allowed; }
        .rolling svg { animation: roll 0.6s linear infinite; }
        @keyframes roll { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- CHAT --- */
        .chat-section {
            height: 160px; background: #0f172a;
            display: flex; flex-direction: column;
        }
        .chat-scroll { flex: 1; overflow-y: auto; padding: 0.75rem; font-family: sans-serif; font-size: 0.8rem; }
        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #334155; }
    </style>
</head>
<body class="flex items-center justify-center h-screen bg-[url('https://images.unsplash.com/photo-1514933651103-005eec06c04b?q=80&w=1974&auto=format&fit=crop')] bg-cover bg-center backdrop-blur-sm">

    <!-- === LOBBY VIEW === -->
    <div id="lobby-panel" class="z-10 widget-container items-center justify-center p-8 text-center animate-pop h-auto min-h-[500px]">
        <i data-lucide="beer" class="w-16 h-16 text-yellow-600 mb-4 mx-auto"></i>
        <h1 class="text-3xl font-bold text-yellow-500 mb-2">THE FIGHTING TAVERN</h1>
        
        <div class="bg-slate-800/80 rounded-lg p-4 w-full mb-6 border border-slate-600">
            <div class="text-xs uppercase text-slate-400 font-bold mb-1 tracking-widest">Tavern Status</div>
            <div id="lobby-status-text" class="text-lg text-white font-bold animate-pulse-glow">Connecting...</div>
            <div id="lobby-count" class="text-xs text-slate-500 mt-1"></div>
        </div>

        <!-- Dynamic Lobby Actions -->
        <div id="lobby-actions" class="w-full space-y-3"></div>
        
        <!-- Challenge Notification (Hidden by default) -->
        <div id="challenge-modal" class="hidden absolute inset-0 bg-black/90 flex-col items-center justify-center p-6 z-50 animate-pop">
            <h2 class="text-2xl text-yellow-500 font-bold mb-2">CHALLENGE!</h2>
            <p class="text-slate-300 text-sm mb-6">A rival warrior wants to fight.</p>
            <button onclick="app.acceptChallenge()" class="w-full bg-red-600 hover:bg-red-500 text-white py-4 rounded-lg font-bold mb-3 animate-pulse">
                ACCEPT BATTLE
            </button>
            <div class="text-xs text-slate-500">Wait to decline...</div>
        </div>
    </div>

    <!-- === GAME WIDGET === -->
    <div id="game-widget" class="widget-container hidden animate-pop">
        
        <!-- Header -->
        <div class="flex justify-between items-center px-3 py-2 bg-slate-900/90 border-b border-slate-700 z-30">
            <div class="flex items-center gap-2">
                <i data-lucide="swords" class="w-4 h-4 text-yellow-500"></i>
                <div id="role-alert" class="text-xs font-bold text-slate-300 uppercase tracking-wider">Loading...</div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="battle.resetGame()" class="text-slate-500 hover:text-yellow-400"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                <button onclick="app.closeWidget()" class="text-slate-500 hover:text-white"><i data-lucide="log-out" class="w-4 h-4"></i></button>
            </div>
        </div>

        <!-- BATTLE STAGE -->
        <div class="battle-stage">
            
            <!-- Hero Panel -->
            <div id="hero-card" class="char-panel group">
                <img id="hero-img" src="" class="char-img" alt="Warrior">
                <div class="char-hud">
                    <div class="flex justify-between text-xs font-bold text-blue-300 mb-1">
                        <span class="drop-shadow-md">WARRIOR</span> <span id="hero-hp-text">50/50</span>
                    </div>
                    <div class="hp-track">
                        <div id="hero-bar" class="hp-fill bg-blue-500" style="width: 100%"></div>
                        <div id="hero-chip" class="hp-chip" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <!-- Enemy Panel -->
            <div id="enemy-card" class="char-panel group">
                <img id="enemy-img" src="" class="char-img" alt="Ogre">
                <div class="char-hud">
                    <div class="flex justify-between text-xs font-bold text-red-300 mb-1">
                        <span class="drop-shadow-md">OGRE</span> <span id="enemy-hp-text">45/45</span>
                    </div>
                    <div class="hp-track">
                        <div id="enemy-bar" class="hp-fill bg-red-500" style="width: 100%"></div>
                        <div id="enemy-chip" class="hp-chip" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTROL DECK -->
        <div class="control-deck">
            <div class="flex-1 text-left pr-4">
                <div class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Battle Log</div>
                <div id="action-log" class="text-sm font-bold text-slate-200 truncate leading-tight">Roll for initiative...</div>
                <div id="math-log" class="text-[10px] font-mono text-yellow-600/80 h-3 leading-none mt-1"></div>
            </div>

            <div id="d20-btn" class="die-btn die-disabled" onclick="battle.sendAttack()">
                <svg viewBox="0 0 100 100" class="w-full h-full overflow-visible">
                    <path d="M50 5 L92 28 L92 72 L50 95 L8 72 L8 28 Z" class="fill-slate-800 stroke-slate-600 stroke-2 transition-colors" id="die-bg"/>
                    <text x="50" y="62" text-anchor="middle" class="fill-slate-500 font-sans font-black text-2xl select-none" id="die-text">20</text>
                </svg>
            </div>
        </div>

        <!-- CHAT -->
        <div class="chat-section">
            <div id="chat-messages" class="chat-scroll space-y-1.5">
                <div class="text-slate-600 text-center italic text-xs mt-1 opacity-50">-- Tavern Chat --</div>
            </div>
            <form onsubmit="battle.sendChat(event)" class="p-2 bg-slate-950 flex gap-2 border-t border-slate-800">
                <input id="chat-input" class="flex-1 bg-slate-900 border border-slate-700 rounded px-3 py-2 text-xs text-white focus:outline-none focus:border-yellow-600 placeholder-slate-600" placeholder="Type your message..." autocomplete="off">
                <button type="submit" class="bg-slate-800 hover:bg-slate-700 text-white rounded px-3 transition-colors"><i data-lucide="send" class="w-4 h-4"></i></button>
            </form>
        </div>

        <!-- OVERLAY -->
        <div id="overlay" class="absolute inset-0 z-50 bg-black/95 flex flex-col items-center justify-center hidden p-6 text-center animate-pop">
            <i id="overlay-icon" data-lucide="skull" class="w-16 h-16 text-slate-700 mb-4"></i>
            <h1 class="text-4xl text-yellow-500 font-bold mb-2 tracking-tight" id="overlay-title">GAME OVER</h1>
            <p class="text-slate-400 mb-8 text-sm max-w-[200px]" id="overlay-sub">The battle has ended.</p>
            
            <button id="overlay-btn" onclick="battle.resetGame()" class="px-8 py-3 bg-red-900 border border-red-600 rounded-lg text-white font-bold hover:bg-red-800 transition-transform active:scale-95 shadow-lg shadow-red-900/20">
                RETURN TO TAVERN
            </button>
        </div>

    </div>

    <script>
        const RAILWAY_URL = "https://fight-tavern-production.up.railway.app";
        // const RAILWAY_URL = "http://localhost:3000"; 
        
        const IMAGES = {
            warrior: "https://image.pollinations.ai/prompt/fantasy%20warrior%20portrait%20rugged%20face%20scarred%20armor%20heroic%20lighting%201970s%20dnd%20art%20style%20oil%20painting?width=400&height=400&nologin=true&seed=99",
            ogre: "https://image.pollinations.ai/prompt/fearsome%20ogre%20portrait%20fantasy%20art%201970s%20style?width=400&height=400&nologin=true&seed=505",
        };

        const socket = io(RAILWAY_URL);

        const app = {
            // Emits specific game mode request
            openGame(mode) {
                if(mode === 'challenge') {
                    // Send challenge
                    socket.emit('send_challenge');
                    document.getElementById('challenge-btn').innerText = "CHALLENGING...";
                    document.getElementById('challenge-btn').disabled = true;
                } else {
                    // PvE or Spectate
                    socket.emit('join_game', { mode: mode });
                    document.getElementById('lobby-panel').classList.add('hidden');
                    document.getElementById('game-widget').classList.remove('hidden');
                    battle.init();
                }
            },
            
            acceptChallenge() {
                socket.emit('accept_challenge');
                document.getElementById('challenge-modal').classList.add('hidden');
                document.getElementById('lobby-panel').classList.add('hidden');
                document.getElementById('game-widget').classList.remove('hidden');
                battle.init();
            },

            closeWidget() {
                document.getElementById('game-widget').classList.add('hidden');
                document.getElementById('lobby-panel').classList.remove('hidden');
            }
        };

        // --- LOBBY LOGIC ---
        socket.on('lobby_stats', (stats) => {
            const statusText = document.getElementById('lobby-status-text');
            const actionsDiv = document.getElementById('lobby-actions');
            const countText = document.getElementById('lobby-count');
            
            countText.innerText = `${stats.connected} Patrons in the Tavern`;
            let actionHtml = '';

            if (stats.gameInProgress) {
                statusText.innerText = "Battle in Progress!";
                statusText.className = "text-lg text-red-400 font-bold animate-pulse";
                actionHtml = `
                    <button onclick="app.openGame('spectate')" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 border border-slate-600"><i data-lucide="eye" class="w-4 h-4"></i> Watch Battle</button>
                `;
            } 
            else if (stats.connected > 1) {
                // 2+ People: Send Challenge
                statusText.innerText = "Opponent Available!";
                statusText.className = "text-lg text-yellow-400 font-bold";
                actionHtml = `
                    <button id="challenge-btn" onclick="app.openGame('challenge')" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white py-4 rounded-lg font-bold flex items-center justify-center gap-2 border border-yellow-400 shadow-lg shadow-yellow-900/20">
                        <i data-lucide="swords" class="w-5 h-5"></i> SEND CHALLENGE
                    </button>
                    <div class="text-center text-xs text-slate-500 mt-2">or</div>
                    <button onclick="app.openGame('pve')" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-400 py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2 border border-slate-700 mt-2">
                        <i data-lucide="bot" class="w-4 h-4"></i> Practice vs CPU
                    </button>
                `;
            } 
            else {
                // 1 Person: CPU Only
                statusText.innerText = "You are Alone...";
                statusText.className = "text-lg text-slate-400 font-bold";
                actionHtml = `
                    <button onclick="app.openGame('pve')" class="w-full bg-blue-900 hover:bg-blue-800 text-blue-100 py-4 rounded-lg font-bold flex items-center justify-center gap-2 border border-blue-700 shadow-lg shadow-blue-900/20">
                        <i data-lucide="bot" class="w-5 h-5"></i> PLAY VS COMPUTER
                    </button>
                    <div class="text-xs text-slate-500 mt-2">Waiting for another human...</div>
                `;
            }
            actionsDiv.innerHTML = actionHtml;
            lucide.createIcons();
        });

        socket.on('challenge_received', () => {
            const modal = document.getElementById('challenge-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        });
        
        socket.on('challenge_canceled', () => {
             const modal = document.getElementById('challenge-modal');
             modal.classList.add('hidden');
             modal.classList.remove('flex');
        });

        // --- GAME LOGIC ---
        const battle = {
            myRole: null, isMyTurn: false,

            init() {
                document.getElementById('hero-img').src = IMAGES.warrior;
                document.getElementById('enemy-img').src = IMAGES.ogre;
                lucide.createIcons();
                this.setupSocket();
            },

            setupSocket() {
                socket.off('welcome'); socket.off('game_update'); socket.off('chat_message'); socket.off('player_left');

                socket.on('welcome', (data) => {
                    this.myRole = data.role;
                    
                    // FIX: Force switch to game view if we are assigned a combat role
                    if (this.myRole === 'hero' || this.myRole === 'enemy') {
                        document.getElementById('lobby-panel').classList.add('hidden');
                        document.getElementById('game-widget').classList.remove('hidden');
                        // Ensure modal is hidden
                        document.getElementById('challenge-modal').classList.add('hidden');
                        document.getElementById('challenge-modal').classList.remove('flex');
                    }

                    const alert = document.getElementById('role-alert');
                    if(this.myRole === 'hero') alert.innerText = "You: Warrior";
                    else if(this.myRole === 'enemy') alert.innerText = "You: Ogre";
                    else alert.innerText = "Spectating";
                    this.updateUI(data.state);
                });

                socket.on('game_update', (data) => {
                    this.updateUI(data.state);
                    if(data.action) this.handleAction(data.action);
                });

                socket.on('player_left', (data) => {
                    const ov = document.getElementById('overlay');
                    ov.classList.remove('hidden');
                    document.getElementById('overlay-title').innerText = "OPPONENT LEFT";
                    document.getElementById('overlay-sub').innerText = "The battle is cancelled.";
                    const btn = document.getElementById('overlay-btn');
                    btn.innerText = "BACK TO LOBBY";
                    btn.onclick = () => {
                        ov.classList.add('hidden');
                        app.closeWidget();
                    };
                });

                socket.on('chat_message', (data) => {
                    const box = document.getElementById('chat-messages');
                    const color = data.role === 'hero' ? 'text-blue-400' : (data.role === 'enemy' ? 'text-red-400' : 'text-slate-500');
                    const name = data.role === 'hero' ? 'WAR' : (data.role === 'enemy' ? 'OGR' : (data.role === 'bot' ? 'CPU' : 'SPEC'));
                    const el = document.createElement('div');
                    el.innerHTML = `<span class="font-bold ${color} text-[10px] mr-1 uppercase tracking-wide">${name}</span><span class="text-slate-300 text-xs">${data.text}</span>`;
                    box.appendChild(el);
                    box.scrollTop = box.scrollHeight;
                });
            },

            sendAttack() {
                if(!this.isMyTurn) return;
                document.getElementById('d20-btn').classList.add('rolling');
                socket.emit('attack');
            },

            sendChat(e) {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                if(input.value.trim()) { socket.emit('send_chat', input.value.trim()); input.value = ''; }
            },

            resetGame() { socket.emit('reset_game'); },

            updateUI(state) {
                const setStats = (id, cur, max) => {
                    document.getElementById(id + '-hp-text').innerText = `${cur}/${max}`;
                    const pct = (cur/max)*100;
                    document.getElementById(id + '-bar').style.width = `${pct}%`;
                    setTimeout(() => document.getElementById(id + '-chip').style.width = `${pct}%`, 500);
                };
                setStats('hero', state.hero.hp, state.hero.max);
                setStats('enemy', state.enemy.hp, state.enemy.max);

                if(state.gameOver) {
                    const ov = document.getElementById('overlay');
                    ov.classList.remove('hidden');
                    document.getElementById('overlay-title').innerText = state.hero.hp > 0 ? "VICTORY" : "DEFEAT";
                    document.getElementById('overlay-sub').innerText = state.hero.hp > 0 ? "The Warrior prevails!" : "The Ogre feasts!";
                    
                    const btn = document.getElementById('overlay-btn');
                    btn.innerText = "PLAY AGAIN";
                    btn.onclick = () => battle.resetGame();
                    return;
                } else if (document.getElementById('overlay-title').innerText !== "OPPONENT LEFT") {
                    document.getElementById('overlay').classList.add('hidden');
                }

                this.isMyTurn = (this.myRole === state.turn);
                const btn = document.getElementById('d20-btn');
                const dieBg = document.getElementById('die-bg');
                const dieText = document.getElementById('die-text');
                
                btn.classList.remove('rolling');

                const heroCard = document.getElementById('hero-card');
                const enemyCard = document.getElementById('enemy-card');
                
                if(state.turn === 'hero') {
                    heroCard.classList.add('active-turn'); heroCard.classList.remove('inactive-turn');
                    enemyCard.classList.remove('active-turn'); enemyCard.classList.add('inactive-turn');
                } else {
                    enemyCard.classList.add('active-turn'); enemyCard.classList.remove('inactive-turn');
                    heroCard.classList.remove('active-turn'); heroCard.classList.add('inactive-turn');
                }

                if(this.isMyTurn) {
                    btn.classList.remove('die-disabled');
                    dieBg.classList.replace('fill-slate-800', 'fill-red-900');
                    dieBg.classList.replace('stroke-slate-600', 'stroke-red-500');
                    dieText.classList.replace('fill-slate-500', 'fill-white');
                    document.getElementById('action-log').innerText = "YOUR TURN";
                    document.getElementById('action-log').className = "text-sm font-bold text-yellow-400 animate-pulse";
                } else {
                    btn.classList.add('die-disabled');
                    dieBg.classList.replace('fill-red-900', 'fill-slate-800');
                    dieBg.classList.replace('stroke-red-500', 'stroke-slate-600');
                    dieText.classList.replace('fill-white', 'fill-slate-500');
                    const who = state.turn === 'hero' ? "Warrior" : "Ogre";
                    document.getElementById('action-log').innerText = `${who} attacking...`;
                    document.getElementById('action-log').className = "text-sm font-bold text-slate-500";
                }
            },

            handleAction(action) {
                document.getElementById('action-log').innerText = action.log.msg;
                document.getElementById('action-log').className = `text-sm font-bold ${action.log.color}`;
                document.getElementById('math-log').innerText = action.log.sub || "";

                const targetId = action.attacker === 'hero' ? 'enemy-card' : 'hero-card';
                const card = document.getElementById(targetId);

                if(action.isHit) {
                    const img = card.querySelector('img');
                    img.style.filter = "sepia(1) hue-rotate(-50deg) saturate(5)";
                    setTimeout(() => img.style.filter = "", 200);
                    
                    card.classList.add('animate-shake');
                    setTimeout(() => card.classList.remove('animate-shake'), 500);
                }
            }
        };
        lucide.createIcons();
    </script>
</body>
</html>
