<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Multiplayer Circle Experiment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; touch-action: none; background-color: #0f172a; }
        canvas { display: block; cursor: crosshair; }
        .ui-panel { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="text-slate-200 font-sans">

    <div class="fixed top-4 left-4 z-10 flex flex-col gap-2">
        <div class="ui-panel p-4 rounded-xl border border-slate-700 shadow-2xl">
            <h1 class="text-xl font-bold mb-1 flex items-center gap-2">
                <div id="status-dot" class="w-3 h-3 rounded-full bg-red-500"></div>
                Sync-Circle
            </h1>
            <p id="status-text" class="text-xs text-slate-400">Connecting to server...</p>
        </div>

        <div class="ui-panel p-3 rounded-xl border border-slate-700 shadow-xl">
            <div class="text-xs uppercase tracking-wider text-slate-500 font-bold mb-2">Active Users</div>
            <div id="user-list" class="flex flex-wrap gap-2 max-w-[200px]"></div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const userList = document.getElementById('user-list');

        let socket = null;
        let myId = Math.random().toString(36).substr(2, 9);
        let myColor = `hsl(${Math.floor(Math.random() * 360)}, 70%, 60%)`;
        let circles = [];

        // Updated with your specific Railway URL
        const RAILWAY_URL = "https://fight-tavern-production.up.railway.app";

        function init() {
            resize();
            window.addEventListener('resize', resize);
            canvas.addEventListener('mousedown', handleInput);
            canvas.addEventListener('touchstart', handleInput, { passive: false });
            
            connectToServer();
            requestAnimationFrame(draw);
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function handleInput(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            let clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const x = clientX - rect.left;
            const y = clientY - rect.top;

            // Send to server
            if (socket && socket.connected) {
                socket.emit('place_circle', { x, y, color: myColor, id: myId });
            }
            // Local preview
            placeCircle(x, y, myColor);
        }

        function placeCircle(x, y, color) {
            circles.push({
                x, y, color, 
                radius: 5, 
                maxRadius: 50,
                birth: Date.now()
            });
        }

        function connectToServer() {
            socket = io(RAILWAY_URL);

            socket.on('connect', () => {
                statusDot.className = "w-3 h-3 rounded-full bg-green-500";
                statusText.innerText = "Online - Click anywhere!";
                socket.emit('register_user', { id: myId, color: myColor });
            });

            socket.on('draw_circle', (data) => {
                if (data.id !== myId) placeCircle(data.x, data.y, data.color);
            });

            socket.on('update_users', (users) => {
                userList.innerHTML = '';
                Object.values(users).forEach(u => {
                    const badge = document.createElement('div');
                    badge.className = `w-6 h-6 rounded-full border-2 border-white/20`;
                    badge.style.backgroundColor = u.color;
                    if (u.id === myId) badge.className += " ring-2 ring-white";
                    userList.appendChild(badge);
                });
            });

            socket.on('disconnect', () => {
                statusDot.className = "w-3 h-3 rounded-full bg-red-500";
                statusText.innerText = "Disconnected";
            });
        }

        function draw() {
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const now = Date.now();
            circles.forEach(c => {
                const age = now - c.birth;
                const alpha = Math.max(0, 1 - (age / 2000));
                if (c.radius < c.maxRadius) c.radius += 3;

                ctx.beginPath();
                ctx.arc(c.x, c.y, c.radius, 0, Math.PI * 2);
                ctx.strokeStyle = c.color;
                ctx.globalAlpha = alpha;
                ctx.lineWidth = 4;
                ctx.stroke();
            });

            circles = circles.filter(c => (now - c.birth) < 2000);
            requestAnimationFrame(draw);
        }

        init();
    </script>
</body>
</html>
