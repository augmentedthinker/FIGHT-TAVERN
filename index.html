<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Multiplayer Battle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        /* --- GLOBAL STYLES --- */
        body { background-color: #020617; color: #e2e8f0; font-family: 'MedievalSharp', cursive; overflow: hidden; }
        .text-glow { text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; }
        
        /* Glassmorphism for HUD */
        .hud-panel { 
            background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(15, 23, 42, 0.8) 100%); 
            backdrop-filter: blur(4px); 
            border-top: 1px solid rgba(255, 255, 255, 0.15); 
        }

        /* --- SPLIT SCREEN ANIMATIONS --- */
        .split-panel {
            position: relative; width: 50%; height: 100%; overflow: hidden;
            transition: width 0.5s ease, filter 0.5s ease;
        }
        /* When it's your turn, your panel expands slightly and brightens */
        .active-turn { width: 55%; filter: brightness(1.1); z-index: 10; border-left: 2px solid rgba(255,255,255,0.1); border-right: 2px solid rgba(255,255,255,0.1); }
        .inactive-turn { width: 45%; filter: grayscale(0.6) brightness(0.6); z-index: 0; }
        
        .split-image { width: 100%; height: 100%; object-fit: cover; object-position: top center; transition: transform 0.5s ease; }
        .active-turn .split-image { transform: scale(1.05); }

        /* HP Bars */
        .hp-track {
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .hp-fill { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Damage Animations */
        .taking-damage .split-image { animation: damage-shake 0.4s cubic-bezier(.36,.07,.19,.97) both; filter: sepia(1) hue-rotate(-50deg) saturate(5); }
        @keyframes damage-shake {
            10%, 90% { transform: translate3d(-2px, 0, 0) scale(1.05); }
            20%, 80% { transform: translate3d(4px, 0, 0) scale(1.05); }
            30%, 50%, 70% { transform: translate3d(-8px, 0, 0) scale(1.05); }
            40%, 60% { transform: translate3d(8px, 0, 0) scale(1.05); }
        }

        /* Floating Text */
        @keyframes floatUp {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            10% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -150%) scale(0.8); opacity: 0; }
        }
        .damage-text {
            position: absolute; left: 50%; top: 30%;
            font-size: 8rem; color: #ef4444; font-weight: 900;
            text-shadow: 4px 4px 0 #000; pointer-events: none; 
            animation: floatUp 2.5s ease-out forwards; z-index: 50;
        }
        .miss-text {
            position: absolute; left: 50%; top: 30%;
            font-size: 6rem; color: #cbd5e1; font-weight: 900;
            text-shadow: 4px 4px 0 #000; pointer-events: none; 
            animation: floatUp 2s ease-out forwards; z-index: 50; opacity: 0.8;
        }

        /* Dice Styles */
        .die-btn {
            width: 80px; height: 80px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
            opacity: 0.3; filter: grayscale(1); cursor: not-allowed; transform: scale(0.9);
        }
        .die-active {
            opacity: 1; filter: grayscale(0) drop-shadow(0 0 10px rgba(220, 38, 38, 0.5));
            transform: scale(1.1); cursor: pointer; animation: pulse-glow 2s infinite;
        }
        .die-active:hover { transform: scale(1.2); }
        @keyframes pulse-glow { 0%, 100% { filter: drop-shadow(0 0 5px rgba(220, 38, 38, 0.4)); } 50% { filter: drop-shadow(0 0 20px rgba(220, 38, 38, 0.9)); } }
        @keyframes roll { 0% { transform: rotate(0deg); } 25% { transform: rotate(15deg); } 75% { transform: rotate(-15deg); } }
        .rolling { animation: roll 0.6s infinite; opacity: 1; filter: grayscale(0); }
        
        /* Chat Scrollbar */
        .scrollbar-hidden::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative bg-black">

    <!-- === LAYER 1: THE VISUALS (Full Screen) === -->
    <div class="absolute inset-0 flex z-0">
        <!-- Hero (Left) -->
        <div id="hero-panel" class="split-panel bg-slate-900 border-r border-black">
            <img id="hero-img" src="" class="split-image" alt="Hero">
        </div>
        
        <!-- Enemy (Right) -->
        <div id="enemy-panel" class="split-panel bg-slate-900 border-l border-black">
            <img id="enemy-img" src="" class="split-image" alt="Enemy">
        </div>
    </div>

    <!-- === LAYER 2: TOP HUD (Health & Status) === -->
    <div class="absolute top-0 left-0 w-full p-4 z-20 flex justify-between items-start pointer-events-none">
        
        <!-- Player 1 Status -->
        <div class="w-1/3 max-w-md pointer-events-auto">
            <div class="flex items-end justify-between mb-1 text-shadow-sm px-1">
                <span class="text-blue-300 font-bold text-lg tracking-widest drop-shadow-md">WARRIOR</span>
                <span id="hero-hp-text" class="text-2xl font-bold text-white drop-shadow-md">50/50</span>
            </div>
            <div class="hp-track h-4 w-full rounded-sm overflow-hidden relative">
                <div id="hero-bar" class="hp-fill bg-gradient-to-r from-blue-700 to-blue-500 h-full" style="width: 100%"></div>
            </div>
            <div class="flex gap-2 mt-2">
                 <div id="p1-status" class="text-[10px] uppercase font-bold text-slate-400 bg-black/50 px-2 py-1 rounded border border-white/10">Connected</div>
            </div>
        </div>

        <!-- Center VS Marker -->
        <div class="text-4xl font-black text-white/20 italic mt-2 drop-shadow-xl select-none">VS</div>

        <!-- Player 2 Status -->
        <div class="w-1/3 max-w-md pointer-events-auto text-right">
            <div class="flex items-end justify-between mb-1 text-shadow-sm px-1 flex-row-reverse">
                <span class="text-red-300 font-bold text-lg tracking-widest drop-shadow-md">OGRE</span>
                <span id="enemy-hp-text" class="text-2xl font-bold text-white drop-shadow-md">45/45</span>
            </div>
            <div class="hp-track h-4 w-full rounded-sm overflow-hidden relative">
                <div id="enemy-bar" class="hp-fill bg-gradient-to-l from-red-700 to-red-500 h-full float-right" style="width: 100%"></div>
            </div>
            <div class="flex gap-2 mt-2 justify-end">
                 <div id="p2-status" class="text-[10px] uppercase font-bold text-slate-400 bg-black/50 px-2 py-1 rounded border border-white/10">Waiting...</div>
            </div>
        </div>

    </div>

    <!-- === LAYER 3: BOTTOM DASHBOARD (Chat & Controls) === -->
    <div class="absolute bottom-0 w-full z-30 hud-panel h-32 md:h-40 flex items-center justify-between px-4 md:px-8">
        
        <!-- LEFT: Chat Module (Embedded) -->
        <div class="w-1/3 h-full py-3 flex flex-col gap-2 max-w-sm">
            <div id="chat-messages" class="flex-1 overflow-y-auto scrollbar-hidden text-xs md:text-sm font-sans space-y-1 pr-2">
                <div class="text-slate-500 italic text-[10px]">Entering the arena...</div>
            </div>
            <form id="chat-form" class="flex gap-2 h-8" onsubmit="battle.sendChat(event)">
                <input type="text" id="chat-input" class="flex-1 bg-black/40 border border-slate-600 rounded px-2 text-xs text-white focus:outline-none focus:border-yellow-600 focus:bg-black/60 transition-colors" placeholder="Say something..." autocomplete="off">
                <button type="submit" class="bg-slate-800 hover:bg-slate-700 text-white px-3 rounded text-xs font-bold border border-slate-600">
                    <i data-lucide="send" class="w-3 h-3"></i>
                </button>
            </form>
        </div>

        <!-- CENTER: Action Deck -->
        <div class="flex-1 flex flex-col items-center justify-center h-full relative">
            
            <!-- Turn Banner -->
            <div class="absolute -top-5">
                <div id="turn-banner" class="bg-black text-white px-6 py-1 rounded-t-lg font-bold uppercase tracking-widest text-[10px] border-t border-x border-white/20 shadow-lg">
                    Initializing...
                </div>
            </div>

            <!-- The Dice -->
            <div id="d20-btn" class="die-btn" onclick="battle.sendAttack()">
                <svg viewBox="0 0 100 100" class="overflow-visible w-full h-full drop-shadow-md">
                    <path d="M50 5 L92 28 L92 72 L50 95 L8 72 L8 28 Z" class="fill-red-900 stroke-red-400 stroke-2" />
                    <path d="M50 5 L28 35 M50 5 L72 35 M92 28 L72 35 M92 72 L72 35 M92 72 L50 75 M50 95 L50 75 M8 72 L50 75 M8 72 L28 35 M8 28 L28 35 M8 28 L50 5 M28 35 L72 35 L50 75 Z" class="fill-none stroke-red-200 stroke-1" />
                    <text x="50" y="62" text-anchor="middle" class="fill-white font-sans font-black text-2xl" style="font-family: sans-serif">20</text>
                </svg>
            </div>
            <div id="log-text" class="text-xs text-slate-400 mt-2 font-sans tracking-wide">Roll for initiative</div>
        </div>

        <!-- RIGHT: Utility (Reset/Info) -->
        <div class="w-1/3 h-full flex items-center justify-end">
            <div class="text-right">
                <div id="role-display" class="text-xs font-bold text-yellow-500 uppercase tracking-widest mb-1">Spectator</div>
                <div class="text-[10px] text-slate-500">Connected to Realm</div>
            </div>
        </div>
    </div>

    <!-- === OVERLAYS (Game Over / Start) === -->
    <div id="overlay" class="absolute inset-0 z-50 bg-black/90 flex flex-col items-center justify-center backdrop-blur-md hidden">
        <h1 class="text-7xl font-black text-white font-old animate-pulse mb-4 tracking-tighter" id="overlay-title">GAME OVER</h1>
        <p class="text-slate-400 font-sans text-sm tracking-[0.3em] font-bold border border-white/10 px-8 py-3 rounded-full bg-white/5" id="overlay-sub">THE BATTLE IS FINISHED</p>
        <button id="reset-btn" onclick="battle.resetGame()" class="mt-12 px-8 py-3 bg-red-900 hover:bg-red-800 rounded-lg text-white font-bold tracking-widest border border-red-500 shadow-[0_0_20px_rgba(220,38,38,0.4)] transition-all transform hover:scale-105 hidden">
            NEW BATTLE
        </button>
    </div>

    <script>
        const RAILWAY_URL = "https://fight-tavern-production.up.railway.app";
        
        const IMAGES = {
            warrior: "https://image.pollinations.ai/prompt/fantasy%20warrior%20portrait%20rugged%20face%20scarred%20armor%20heroic%20lighting%201970s%20dnd%20art%20style%20oil%20painting?width=600&height=1024&nologin=true&seed=99",
            ogre: "https://image.pollinations.ai/prompt/fearsome%20ogre%20portrait%20fantasy%20art%201970s%20style?width=600&height=1024&nologin=true&seed=505",
        };

        const socket = io(RAILWAY_URL);

        const battle = {
            myRole: null, 
            isMyTurn: false,

            init() {
                document.getElementById('hero-img').src = IMAGES.warrior;
                document.getElementById('enemy-img').src = IMAGES.ogre;
                this.setupSocket();
                lucide.createIcons();
            },

            setupSocket() {
                socket.on('connect', () => {
                   // Connection logic handled by 'welcome'
                });

                socket.on('welcome', (data) => {
                    this.myRole = data.role;
                    let roleText = "SPECTATING";
                    if (this.myRole === 'hero') roleText = "YOU ARE THE WARRIOR";
                    if (this.myRole === 'enemy') roleText = "YOU ARE THE OGRE";
                    document.getElementById('role-display').innerText = roleText;
                    this.updateUI(data.state);
                });

                socket.on('game_update', (data) => {
                    this.updateUI(data.state);
                    if (data.action) this.playActionAnimation(data.action);
                    if (data.reset) document.getElementById('overlay').classList.add('hidden');
                });

                socket.on('chat_message', (data) => this.addChatMessage(data));
            },

            sendAttack() {
                if (!this.isMyTurn) return;
                document.getElementById('d20-btn').classList.add('rolling');
                socket.emit('attack');
            },

            sendChat(e) {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                const msg = input.value.trim();
                if (!msg) return;
                socket.emit('send_chat', msg);
                input.value = '';
            },

            addChatMessage(data) {
                const list = document.getElementById('chat-messages');
                const el = document.createElement('div');
                let colorClass = "text-slate-500";
                let name = "Spectator";
                
                if (data.role === 'hero') { colorClass = "text-blue-400"; name = "WARRIOR"; }
                if (data.role === 'enemy') { colorClass = "text-red-400"; name = "OGRE"; }
                
                el.innerHTML = `<span class="font-bold text-[10px] ${colorClass}">${name}</span> <span class="text-slate-300 ml-1">${data.text}</span>`;
                list.appendChild(el);
                list.scrollTop = list.scrollHeight;
            },

            resetGame() {
                socket.emit('reset_game');
            },

            updateUI(state) {
                // Update HP Texts
                document.getElementById('hero-hp-text').innerText = `${state.hero.hp}/${state.hero.max}`;
                document.getElementById('enemy-hp-text').innerText = `${state.enemy.hp}/${state.enemy.max}`;
                
                // Update Bars
                const heroPct = (state.hero.hp / state.hero.max) * 100;
                const enemyPct = (state.enemy.hp / state.enemy.max) * 100;
                document.getElementById('hero-bar').style.width = `${heroPct}%`;
                document.getElementById('enemy-bar').style.width = `${enemyPct}%`;

                if (state.gameOver) {
                    this.showGameOver(state);
                    return;
                }

                // Turn Logic
                const turnBanner = document.getElementById('turn-banner');
                const d20Btn = document.getElementById('d20-btn');
                this.isMyTurn = (this.myRole === state.turn);

                // Expand/Contract Panels based on turn
                if (state.turn === 'hero') {
                    document.getElementById('hero-panel').className = "split-panel active-turn bg-slate-900 border-r border-white/20";
                    document.getElementById('enemy-panel').className = "split-panel inactive-turn bg-slate-900 border-l border-black";
                } else {
                    document.getElementById('hero-panel').className = "split-panel inactive-turn bg-slate-900 border-r border-black";
                    document.getElementById('enemy-panel').className = "split-panel active-turn bg-slate-900 border-l border-white/20";
                }

                d20Btn.classList.remove('rolling');
                if (this.isMyTurn) {
                    turnBanner.innerText = "YOUR TURN";
                    turnBanner.className = "bg-yellow-600 text-black px-6 py-1 rounded-t-lg font-bold uppercase tracking-widest text-[10px] border-t border-x border-yellow-400 shadow-[0_-5px_15px_rgba(202,138,4,0.4)] animate-pulse absolute -top-5";
                    d20Btn.classList.add('die-active');
                    document.getElementById('log-text').innerText = "Tap the D20 to attack!";
                    document.getElementById('log-text').className = "text-xs text-yellow-400 mt-2 font-sans tracking-wide font-bold";
                } else {
                    const who = state.turn === 'hero' ? "WARRIOR" : "OGRE";
                    turnBanner.innerText = `${who} IS ATTACKING`;
                    turnBanner.className = "bg-slate-800 text-slate-400 px-6 py-1 rounded-t-lg font-bold uppercase tracking-widest text-[10px] border-t border-x border-slate-600 absolute -top-5";
                    d20Btn.classList.remove('die-active');
                    document.getElementById('log-text').innerText = "Waiting for opponent...";
                    document.getElementById('log-text').className = "text-xs text-slate-500 mt-2 font-sans tracking-wide";
                }
            },

            playActionAnimation(action) {
                const logEl = document.getElementById('log-text');
                logEl.innerText = action.log.msg;
                logEl.className = `text-xs mt-2 font-sans font-bold tracking-wide ${action.log.color}`;

                const targetPanel = action.attacker === 'hero' ? 'enemy' : 'hero';
                const panelEl = document.getElementById(`${targetPanel}-panel`);

                if (action.isHit) {
                    // Create floating text
                    const text = document.createElement('div');
                    text.className = 'damage-text';
                    text.innerText = `-${action.damage}`;
                    panelEl.appendChild(text);
                    setTimeout(() => text.remove(), 2500);

                    // Shake
                    panelEl.classList.add('taking-damage');
                    setTimeout(() => panelEl.classList.remove('taking-damage'), 400);
                } else {
                    const text = document.createElement('div');
                    text.className = 'miss-text';
                    text.innerText = "MISS";
                    panelEl.appendChild(text);
                    setTimeout(() => text.remove(), 2000);
                }
            },

            showGameOver(state) {
                const overlay = document.getElementById('overlay');
                const title = document.getElementById('overlay-title');
                const sub = document.getElementById('overlay-sub');
                const btn = document.getElementById('reset-btn');
                
                overlay.classList.remove('hidden');
                btn.classList.remove('hidden');

                const winner = state.hero.hp > 0 ? 'hero' : 'enemy';
                const iAmWinner = this.myRole === winner;

                if (iAmWinner) {
                    title.innerText = "VICTORY";
                    title.className = "text-6xl md:text-8xl font-black text-yellow-500 font-old animate-pulse drop-shadow-[0_0_35px_rgba(234,179,8,0.6)] mb-4 tracking-tighter";
                    sub.innerText = "GLORY TO THE VICTOR";
                } else if (this.myRole === 'spectator') {
                    title.innerText = "GAME OVER";
                    title.className = "text-6xl md:text-8xl font-black text-white font-old mb-4 tracking-tighter";
                    sub.innerText = `${winner.toUpperCase()} TRIUMPHS`;
                } else {
                    title.innerText = "DEFEAT";
                    title.className = "text-6xl md:text-8xl font-black text-red-600 font-old mb-4 tracking-tighter";
                    sub.innerText = "YOU HAVE FALLEN";
                }
            }
        };

        window.onload = () => battle.init();
    </script>
</body>
</html>
